/**
  ******************************************************************************
  * proj    firmware startup project
  * file    NTC.c
  * ver     1.0
  * brief   This is a NTC file for all C files.
  ------------------------------------------------------------------------------
  * 2012.02 created by taoyu@bakai.com
  */ 

/* File Id -------------------------------------------------------------------*/
#define _NTC_C_ 0x53
#define FILE_No _NTC_C_

/* Includes ------------------------------------------------------------------*/
#include  "ntc.h"  /* mandotary */
#include  "mcu.h"

/* Private Macros & Defines --------------------------------------------------*/

#define   NTC_CURVE_MAX   3

#ifndef   TUNE_NTC
#define   TUNE_NTC    0
#endif

#if   TUNE_NTC
#define   NTC_PRINTF  PRINTF
#else
#define   NTC_PRINTF  empty_printf
#endif

/* Private typedefs ----------------------------------------------------------*/

typedef struct
{
  signed char  t;  //  -128C ~ 127C
  unsigned long r; //  1 ohm/bit
}
temp_node_t;

typedef struct
{
  char * name;
  temp_node_t * curve;
  unsigned char length;
}
temp_curve_t;

/* Private consts ------------------------------------------------------------*/

//  CWF4-103F-4150F/¦µ6-L1000
const temp_node_t temp_curve_cwf4[] = 
{
  { -55,1104010 },
  { -54,1026770 },
  { -53,955265 },
  { -52,889040 },
  { -51,827693 },
  { -50,770849 },
  { -49,718161 },
  { -48,669311 },
  { -47,624006 },
  { -46,581976 },
  { -45,542972 },
  { -44,506765 },
  { -43,473143 },
  { -42,441913 },
  { -41,412894 },
  { -40,385921 },
  { -39,360842 },
  { -38,337516 },
  { -37,315813 },
  { -36,295614 },
  { -35,276807 },
  { -34,259292 },
  { -33,242974 },
  { -32,227765 },
  { -31,213586 },
  { -30,200363 },
  { -29,188027 },
  { -28,176513 },
  { -27,165765 },
  { -26,155727 },
  { -25,146350 },
  { -24,137586 },
  { -23,129393 },
  { -22,121731 },
  { -21,114564 },
  { -20,107856 },
  { -19,101577 },
  { -18,95697 },
  { -17,90189 },
  { -16,85027 },
  { -15,80188 },
  { -14,75651 },
  { -13,71394 },
  { -12,67401 },
  { -11,63652 },
  { -10,60131 },
  { -9,56825  },
  { -8,53718  },
  { -7,50798  },
  { -6,48052  },
  { -5,45470  },
  { -4,43041  },
  { -3,40754  },
  { -2,38601  },
  { -1,36574  },
  { 0,34665   },
  { 1,32865   },
  { 2,31168   },
  { 3,29569   },
  { 4,28060   },
  { 5,26636   },
  { 6,25293   },
  { 7,24024  },
  { 8,22826  },
  { 9,21694  },
  { 10,20690 },
  { 11,19613 },
  { 12,18658 },
  { 13,17753 },
  { 14,16898 },
  { 15,16088 },
  { 16,15322 },
  { 17,14596 },
  { 18,13909 },
  { 19,13257 },
  { 20,12640 },
  { 21,12055 },
  { 22,11500 },
  { 23,10973 },
  { 24,10474 },
  { 25,10000 },
  { 26,9549  },
  { 27,9122 },
  { 28,8716 },
  { 29,8330 },
  { 30,7964 },
  { 31,7615 },
  { 32,7284 },
  { 33,6968 },
  { 34,6669 },
  { 35,6383 },
  { 36,6112 },
  { 37,5853 },
  { 38,5607 },
  { 39,5372 },
  { 40,5148 },
  { 41,4935 },
  { 42,4732 },
  { 43,4538 },
  { 44,4353 },
  { 45,4177 },
  { 46,4009 },
  { 47,3848 },
  { 48,3695 },
  { 49,3549 },
  { 50,3410 },
  { 51,3275 },
  { 52,3148 },
  { 53,3026 },
  { 54,2909 },
  { 55,2797 },
  { 56,2691 },
  { 57,2588 },
  { 58,2491 },
  { 59,2397 },
  { 60,2308 },
  { 61,2222 },
  { 62,2140 },
  { 63,2061 },
  { 64,1986 },
  { 65,1914 },
  { 66,1845 },
  { 67,1778 },
  { 68,1715 },
  { 69,1654 },
  { 70,1595 },
  { 71,1539 },
  { 72,1485 },
  { 73,1433 },
  { 74,1383 },
  { 75,1336 },
  { 76,1290 },
  { 77,1246 },
  { 78,1203 },
  { 79,1163 },
  { 80,1124 },
  { 81,1086 },
  { 82,1050 },
  { 83,1015 },
  { 84,982  },
  { 85,950  },
  { 86,919  },
  { 87,889  },
  { 88,860  },
  { 89,832  },
  { 90,806  },
  { 91,780  },
  { 92,755  },
  { 93,732  },
  { 94,709  },
  { 95,687  },
  { 96,665  },
  { 97,645  },
  { 98,625  },
  { 99,606  },
  { 100,588 },
  { 101,570 },
  { 102,553 },
  { 103,536 },
  { 104,520 },
  { 105,505 },
  { 106,490 },
  { 107,475 },
  { 108,461 },
  { 109,448 },
  { 110,435 },
  { 111,422 },
  { 112,410 },
  { 113,399 },
  { 114,387 },
  { 115,376 },
  { 116,366 },
  { 117,355 },
  { 118,346 },
  { 119,336 },
  { 120,327 },
  { 121,318 },
  { 122,309 },
  { 123,301 },
  { 124,292 },
  { 125,285 },
};

//  epcos
const temp_node_t temp_curve_epcos[] = {
//	T		R	
{ -40,188500 },
{ -39,178500 },
{ -38,169000 },
{ -37,160200 },
{ -36,151900 },
{ -35,144100 },
{ -34,136700 },
{ -33,129800 },
{ -32,123300 },
{ -31,117100 },
{ -30,111300 },
{ -29,105700 },
{ -28,100500 },
{ -27,95520 },
{ -26,90840 },
{ -25,86430 },
{ -24,82260 },
{ -23,78330 },
{ -22,74610 },
{ -21,71100 },
{ -20,67770 },
{ -19,64570 },
{ -18,61540 },
{ -17,58680 },
{ -16,55970 },
{ -15,53410 },
{ -14,50980 },
{ -13,48680 },
{ -12,46500 },
{ -11,44430 },
{ -10,42470 },
{ -9,40570 },
{ -8,38770 },
{ -7,37060 },
{ -6,35440 },
{ -5,33900 },
{ -4,32440 },
{ -3,31050 },
{ -2,29730 },
{ -1,28480 },
{ 0,27280 },
{ 1,26130 },
{ 2,25030 },
{ 3,23990 },
{ 4,23000 },
{ 5,22050 },
{ 6,21150 },
{ 7,20300 },
{ 8,19480 },
{ 9,18700 },
{ 10,17960 },
{ 11,17240 },
{ 12,16560 },
{ 13,15900 },
{ 14,15280 },
{ 15,14690 },
{ 16,14120 },
{ 17,13580 },
{ 18,13060 },
{ 19,12560 },
{ 20,12090 },
{ 21,11630 },
{ 22,11200 },
{ 23,10780 },
{ 24,10380 },
{ 25,10000 },
{ 26,9632 },
{ 27,9281 },
{ 28,8944 },
{ 29,8622 },
{ 30,8313 },
{ 31,8014 },
{ 32,7728 },
{ 33,7454 },
{ 34,7192 },
{ 35,6940 },
{ 36,6699 },
{ 37,6467 },
{ 38,6245 },
{ 39,6032 },
{ 40,5827 },
{ 41,5629 },
{ 42,5438 },
{ 43,5255 },
{ 44,5080 },
{ 45,4911 },
{ 46,4749 },
{ 47,4593 },
{ 48,4443 },
{ 49,4299 },
{ 50,4160 },
{ 51,4026 },
{ 52,3896 },
{ 53,3771 },
{ 54,3651 },
{ 55,3536 },
{ 56,3425 },
{ 57,3318 },
{ 58,3215 },
{ 59,3116 },
{ 60,3020 },
{ 61,2927 },
{ 62,2838 },
{ 63,2751 },
{ 64,2668 },
{ 65,2588 },
{ 66,2511 },
{ 67,2436 },
{ 68,2364 },
{ 69,2295 },
{ 70,2228 },
{ 71,2163 },
{ 72,2100 },
{ 73,2039 },
{ 74,1980 },
{ 75,1924 },
{ 76,1869 },
{ 77,1816 },
{ 78,1765 },
{ 79,1716 },
{ 80,1668 },
{ 81,1622 },
{ 82,1577 },
{ 83,1533 },
{ 84,1492 },
{ 85,1451 },
{ 86,1412 },
{ 87,1373 },
{ 88,1336 },
{ 89,1301 },
{ 90,1266 },
{ 91,1232 },
{ 92,1200 },
{ 93,1168 },
{ 94,1137 },
{ 95,1108 },
{ 96,1079 },
{ 97,1051 },
{ 98,1024 },
{ 99,998.4 },
{ 100,973.1 },
{ 101,948.4 },
{ 102,924.6 },
{ 103,901.4 },
{ 104,878.9 },
{ 105,857.2 },
{ 106,836 },
{ 107,815.5 },
{ 108,795.6 },
{ 109,776.3 },
{ 110,757.6 },
};

//  muRata NXFT15XH103
const temp_node_t temp_curve_muRata[] = {
//	T		R	
{	-40	,	197388	},
{	-35	,	149395	},
{	-30	,	114345	},
{	-25	,	88381	},
{	-20	,	68915	},
{	-15	,	54166	},
{	-10	,	42899	},
{	-5	,	34196	},
{	0	,	27455	},
{	5	,	22165	},
{	10	,	18010	},
{	15	,	14720	},
{	20	,	12099	},
{	25	,	10000	},
{	30	,	8309	},
{	35	,	6939	},
{	40	,	5824	},
{	45	,	4911	},
{	50	,	4160	},
{	55	,	3539	},
{	60	,	3024	},
{	65	,	2593	},
{	70	,	2233	},
{	75	,	1929	},
{	80	,	1673	},
{	85	,	1455	},
{	90	,	1270	},
{	95	,	1112	},
{	100	,	976	},
{	105	,	860	},
{	110	,	759	},
{	115	,	673	},
{	120	,	598	},
{	125	,	532	},
};


const temp_curve_t temp_curve[NTC_CURVE_MAX] = 
{
  {
    "CWF4-103F-4150F/¦µ6-L1000",
    (temp_node_t*)temp_curve_cwf4,
    sizeof(temp_curve_cwf4)/sizeof(temp_node_t),
  },
  {
    "EPCOS",
    (temp_node_t*)temp_curve_epcos,
    sizeof(temp_curve_epcos)/sizeof(temp_node_t),
  },
  {
    "MURATA-NXFT15XH103",
    (temp_node_t*)temp_curve_muRata,
    sizeof(temp_curve_muRata)/sizeof(temp_node_t),
  },
};


/* Private variables ---------------------------------------------------------*/

/* Private function prototypes -----------------------------------------------*/

/* Global consts -------------------------------------------------------------*/

/* Global variables ----------------------------------------------------------*/

/* Functions -----------------------------------------------------------------*/

/**
  * bref    NTC function
  * param   none
  * retval  none
  */

static unsigned char ntc_search(unsigned long res, temp_node_t * curve, unsigned char length)
{
  unsigned char a, b;
  unsigned short c;
  
  a = 0;
  b = length-1;

  NTC_PRINTF("NTC: ");

  if( res > curve[a].r ) return a;
  if( res < curve[b].r ) return b;

  for(;;){

//    DBG_PRINTF("%d|%d,",a,b);
    NTC_PRINTF("%d|%d,",a,b);

    if( a+1==b ) return a;
    c = (a+b+1)/2;
    if( res > curve[c].r ){ b = (unsigned char)c; continue; }
    if( res < curve[c].r ){ a = (unsigned char)c; continue; }
    return (unsigned char)c;

  }  

}

static signed short ntc_insert(unsigned long res, temp_node_t * curve, unsigned char pos, unsigned char length)
{

  signed short ta, tb;
  signed long  ra, rb;
  signed long  tmp1, tmp2;
  
  if( pos>length-1 ){
    PWARNO(WARNO_INDEX_OVERFLOW,pos);
    pos = length-1;
  }
  ta = curve[pos].t * 10;
  if( pos==length-1 ) return ta;
  if( pos==0 && res>curve[pos].r ) return ta;
  
  ra = curve[pos].r;
  tb = curve[pos+1].t * 10;
  rb = curve[pos+1].r;

  /*
    ta - tb    T - tb     ta - T               ta(R-rb) + tb(ra-R)
    ------- = -------- = --------  ====>   T = -------------------
    ra - rb    R - rb     ra - R                     ra - rb
  */
  tmp1 = res - rb;
  tmp1 *= ta;
  tmp2 = ra - res;
  tmp2 *= tb;
  tmp1 = tmp1 + tmp2;
  tmp2 = ra - rb;
  if( tmp2==0 ){
    PERRNO(ERRNO_DIVIDE_ZERO,0);
    return -2730;
  }
  tmp1 = tmp1+(tmp2+1)/2;
  tmp1 /= tmp2;  
  if( tmp1>0xFFFF ){
    PERRNO(ERRNO_CALC_OVERFLOW,(int)(tmp1>>16));
    return -2730;
  }

  return (signed short)tmp1;

}

signed short ntc_res_to_temp(unsigned long res, unsigned char type)
{

  temp_node_t *  curve;
  unsigned char  length;
  unsigned char  pos;
  signed short   temp;
  

  if( type>=NTC_CURVE_MAX ){
    PERRNO(ERRNO_INVALID_PARAMETERS,type);
    return  -2730;
  }

  curve = temp_curve[type].curve;
  length = temp_curve[type].length;
//  DBG_PRINTF("ntc search\n");
  pos = ntc_search(res,curve,length);
  
  NTC_PRINTF(">> %dC @ %d, ", curve[pos].t, pos);
  
//  DBG_PRINTF("ntc insert\n");
  temp = ntc_insert(res,curve,pos,length);
  NTC_PRINTF(">> %d, ", (int)temp);

  return temp;

}

