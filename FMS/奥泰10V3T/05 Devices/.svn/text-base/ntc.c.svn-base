/**
  ******************************************************************************
  * proj    firmware startup project
  * file    NTC.c
  * ver     1.0
  * brief   This is a NTC file for all C files.
  ------------------------------------------------------------------------------
  * 2012.02 created by taoyu@bakai.com
  */ 

/* File Id -------------------------------------------------------------------*/
#define _NTC_C_ 0x53
#define FILE_No _NTC_C_

/* Includes ------------------------------------------------------------------*/
#include  "ntc.h"  /* mandotary */
#include  "mcu.h"

/* Private Macros & Defines --------------------------------------------------*/

#define   NTC_CURVE_MAX   3

#ifndef   TUNE_NTC
#define   TUNE_NTC    0
#endif

#if   TUNE_NTC
#define   NTC_PRINTF  PRINTF
#else
#define   NTC_PRINTF  empty_printf
#endif

/* Private typedefs ----------------------------------------------------------*/

typedef struct
{
  signed char  t;  //  -128C ~ 127C
  unsigned long r; //  1 ohm/bit
}
temp_node_t;

typedef struct
{
  char * name;
  temp_node_t * curve;
  unsigned char length;
}
temp_curve_t;

/* Private consts ------------------------------------------------------------*/

//  CWF4-103F-4150F/¦µ6-L1000
const temp_node_t temp_curve_cwf4[] = 
{
  { -55,1104010 },
  { -54,1026770 },
  { -53,955265 },
  { -52,889040 },
  { -51,827693 },
  { -50,770849 },
  { -49,718161 },
  { -48,669311 },
  { -47,624006 },
  { -46,581976 },
  { -45,542972 },
  { -44,506765 },
  { -43,473143 },
  { -42,441913 },
  { -41,412894 },
  { -40,385921 },
  { -39,360842 },
  { -38,337516 },
  { -37,315813 },
  { -36,295614 },
  { -35,276807 },
  { -34,259292 },
  { -33,242974 },
  { -32,227765 },
  { -31,213586 },
  { -30,200363 },
  { -29,188027 },
  { -28,176513 },
  { -27,165765 },
  { -26,155727 },
  { -25,146350 },
  { -24,137586 },
  { -23,129393 },
  { -22,121731 },
  { -21,114564 },
  { -20,107856 },
  { -19,101577 },
  { -18,95697 },
  { -17,90189 },
  { -16,85027 },
  { -15,80188 },
  { -14,75651 },
  { -13,71394 },
  { -12,67401 },
  { -11,63652 },
  { -10,60131 },
  { -9,56825  },
  { -8,53718  },
  { -7,50798  },
  { -6,48052  },
  { -5,45470  },
  { -4,43041  },
  { -3,40754  },
  { -2,38601  },
  { -1,36574  },
  { 0,34665   },
  { 1,32865   },
  { 2,31168   },
  { 3,29569   },
  { 4,28060   },
  { 5,26636   },
  { 6,25293   },
  { 7,24024  },
  { 8,22826  },
  { 9,21694  },
  { 10,20690 },
  { 11,19613 },
  { 12,18658 },
  { 13,17753 },
  { 14,16898 },
  { 15,16088 },
  { 16,15322 },
  { 17,14596 },
  { 18,13909 },
  { 19,13257 },
  { 20,12640 },
  { 21,12055 },
  { 22,11500 },
  { 23,10973 },
  { 24,10474 },
  { 25,10000 },
  { 26,9549  },
  { 27,9122 },
  { 28,8716 },
  { 29,8330 },
  { 30,7964 },
  { 31,7615 },
  { 32,7284 },
  { 33,6968 },
  { 34,6669 },
  { 35,6383 },
  { 36,6112 },
  { 37,5853 },
  { 38,5607 },
  { 39,5372 },
  { 40,5148 },
  { 41,4935 },
  { 42,4732 },
  { 43,4538 },
  { 44,4353 },
  { 45,4177 },
  { 46,4009 },
  { 47,3848 },
  { 48,3695 },
  { 49,3549 },
  { 50,3410 },
  { 51,3275 },
  { 52,3148 },
  { 53,3026 },
  { 54,2909 },
  { 55,2797 },
  { 56,2691 },
  { 57,2588 },
  { 58,2491 },
  { 59,2397 },
  { 60,2308 },
  { 61,2222 },
  { 62,2140 },
  { 63,2061 },
  { 64,1986 },
  { 65,1914 },
  { 66,1845 },
  { 67,1778 },
  { 68,1715 },
  { 69,1654 },
  { 70,1595 },
  { 71,1539 },
  { 72,1485 },
  { 73,1433 },
  { 74,1383 },
  { 75,1336 },
  { 76,1290 },
  { 77,1246 },
  { 78,1203 },
  { 79,1163 },
  { 80,1124 },
  { 81,1086 },
  { 82,1050 },
  { 83,1015 },
  { 84,982  },
  { 85,950  },
  { 86,919  },
  { 87,889  },
  { 88,860  },
  { 89,832  },
  { 90,806  },
  { 91,780  },
  { 92,755  },
  { 93,732  },
  { 94,709  },
  { 95,687  },
  { 96,665  },
  { 97,645  },
  { 98,625  },
  { 99,606  },
  { 100,588 },
  { 101,570 },
  { 102,553 },
  { 103,536 },
  { 104,520 },
  { 105,505 },
  { 106,490 },
  { 107,475 },
  { 108,461 },
  { 109,448 },
  { 110,435 },
  { 111,422 },
  { 112,410 },
  { 113,399 },
  { 114,387 },
  { 115,376 },
  { 116,366 },
  { 117,355 },
  { 118,346 },
  { 119,336 },
  { 120,327 },
  { 121,318 },
  { 122,309 },
  { 123,301 },
  { 124,292 },
  { 125,285 },
};

//  epcos
const temp_node_t temp_curve_epcos[] = {
//	T		R	
{	-55	,	963000	},
{	-50	,	670100	},
{	-45	,	471700	},
{	-40	,	336500	},
{	-35	,	242600	},
{	-30	,	177000	},
{	-25	,	130400	},
{	-20	,	97070	},
{	-15	,	72930	},
{	-10	,	55330	},
{	-5	,	42320	},
{	0	,	32650	},
{	5	,	25390	},
{	10	,	19900	},
{	15	,	15710	},
{	20	,	12490	},
{	25	,	10000	},
{	30	,	8057	},
{	35	,	6531	},
{	40	,	5327	},
{	45	,	4369	},
{	50	,	3603	},
{	55	,	2986	},
{	60	,	2488	},
{	65	,	2083	},
{	70	,	1752	},
{	75	,	1481	},
{	80	,	1258	},
{	85	,	1072	},
{	90	,	918	},
{	95	,	789	},
{	100	,	680	},
{	105	,	589	},
{	110	,	511	},
{	115	,	445	},
{	120	,	389	},
{	125	,	342	},
{	130	,	300	},
{	135	,	265	},
{	140	,	235	},
{	145	,	208	},
{	150	,	185	},
{	155	,	165	},
};

//  muRata NXFT15XH103
const temp_node_t temp_curve_muRata[] = {
//	T		R	
{	-40	,	197388	},
{	-35	,	149395	},
{	-30	,	114345	},
{	-25	,	88381	},
{	-20	,	68915	},
{	-15	,	54166	},
{	-10	,	42899	},
{	-5	,	34196	},
{	0	,	27455	},
{	5	,	22165	},
{	10	,	18010	},
{	15	,	14720	},
{	20	,	12099	},
{	25	,	10000	},
{	30	,	8309	},
{	35	,	6939	},
{	40	,	5824	},
{	45	,	4911	},
{	50	,	4160	},
{	55	,	3539	},
{	60	,	3024	},
{	65	,	2593	},
{	70	,	2233	},
{	75	,	1929	},
{	80	,	1673	},
{	85	,	1455	},
{	90	,	1270	},
{	95	,	1112	},
{	100	,	976	},
{	105	,	860	},
{	110	,	759	},
{	115	,	673	},
{	120	,	598	},
{	125	,	532	},
};


const temp_curve_t temp_curve[NTC_CURVE_MAX] = 
{
  {
    "CWF4-103F-4150F/¦µ6-L1000",
    (temp_node_t*)temp_curve_cwf4,
    sizeof(temp_curve_cwf4)/sizeof(temp_node_t),
  },
  {
    "EPCOS",
    (temp_node_t*)temp_curve_epcos,
    sizeof(temp_curve_epcos)/sizeof(temp_node_t),
  },
  {
    "MURATA-NXFT15XH103",
    (temp_node_t*)temp_curve_muRata,
    sizeof(temp_curve_muRata)/sizeof(temp_node_t),
  },
};


/* Private variables ---------------------------------------------------------*/

/* Private function prototypes -----------------------------------------------*/

/* Global consts -------------------------------------------------------------*/

/* Global variables ----------------------------------------------------------*/

/* Functions -----------------------------------------------------------------*/

/**
  * bref    NTC function
  * param   none
  * retval  none
  */

static unsigned char ntc_search(unsigned long res, temp_node_t * curve, unsigned char length)
{
  unsigned char a, b;
  unsigned short c;
  
  a = 0;
  b = length-1;

  NTC_PRINTF("NTC: ");

  if( res > curve[a].r ) return a;
  if( res < curve[b].r ) return b;

  for(;;){

//    DBG_PRINTF("%d|%d,",a,b);
    NTC_PRINTF("%d|%d,",a,b);

    if( a+1==b ) return a;
    c = (a+b+1)/2;
    if( res > curve[c].r ){ b = (unsigned char)c; continue; }
    if( res < curve[c].r ){ a = (unsigned char)c; continue; }
    return (unsigned char)c;

  }  

}

static signed short ntc_insert(unsigned long res, temp_node_t * curve, unsigned char pos, unsigned char length)
{

  signed short ta, tb;
  signed long  ra, rb;
  signed long  tmp1, tmp2;
  
  if( pos>length-1 ){
    PWARNO(WARNO_INDEX_OVERFLOW,pos);
    pos = length-1;
  }
  ta = curve[pos].t * 10;
  if( pos==length-1 ) return ta;
  if( pos==0 && res>curve[pos].r ) return ta;
  
  ra = curve[pos].r;
  tb = curve[pos+1].t * 10;
  rb = curve[pos+1].r;

  /*
    ta - tb    T - tb     ta - T               ta(R-rb) + tb(ra-R)
    ------- = -------- = --------  ====>   T = -------------------
    ra - rb    R - rb     ra - R                     ra - rb
  */
  tmp1 = res - rb;
  tmp1 *= ta;
  tmp2 = ra - res;
  tmp2 *= tb;
  tmp1 = tmp1 + tmp2;
  tmp2 = ra - rb;
  if( tmp2==0 ){
    PERRNO(ERRNO_DIVIDE_ZERO,0);
    return -2730;
  }
  tmp1 = tmp1+(tmp2+1)/2;
  tmp1 /= tmp2;  
  if( tmp1>0xFFFF ){
    PERRNO(ERRNO_CALC_OVERFLOW,(int)(tmp1>>16));
    return -2730;
  }

  return (signed short)tmp1;

}

signed short ntc_res_to_temp(unsigned long res, unsigned char type)
{

  temp_node_t *  curve;
  unsigned char  length;
  unsigned char  pos;
  signed short   temp;
  

  if( type>=NTC_CURVE_MAX ){
    PERRNO(ERRNO_INVALID_PARAMETERS,type);
    return  -2730;
  }

  curve = temp_curve[type].curve;
  length = temp_curve[type].length;
//  DBG_PRINTF("ntc search\n");
  pos = ntc_search(res,curve,length);
  
  NTC_PRINTF(">> %dC @ %d, ", curve[pos].t, pos);
  
//  DBG_PRINTF("ntc insert\n");
  temp = ntc_insert(res,curve,pos,length);
  NTC_PRINTF(">> %d, ", (int)temp);

  return temp;

}

